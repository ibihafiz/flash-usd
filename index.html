<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Flash USDT Minting Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* CSS remains unchanged from your original */
    :root {
      --primary: #2c3e50;
      --secondary: #3498db;
      --success: #2ecc71;
      --danger: #e74c3c;
      --dark: #1a2530;
      --light: #f8f9fa;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #1a2a3a, #0d1b2a);
      color: var(--light);
      min-height: 100vh;
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      color: #3498db;
      text-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
    }

    .subtitle {
      color: #95a5a6;
      font-size: 1.1rem;
    }

    .card {
      background: rgba(26, 37, 48, 0.8);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 25px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
    }

    .card-title {
      font-size: 1.4rem;
      margin-bottom: 20px;
      color: #3498db;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .wallet-info {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .wallet-status {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 15px;
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.2);
    }

    .status-indicator {
      width: 15px;
      height: 15px;
      border-radius: 50%;
      background: var(--danger);
    }

    .status-indicator.connected {
      background: var(--success);
    }

    .network-info {
      display: flex;
      justify-content: space-between;
      padding: 15px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
    }

    .btn {
      background: var(--secondary);
      color: white;
      border: none;
      padding: 14px 25px;
      font-size: 1.1rem;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .btn:hover {
      background: #2980b9;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-success {
      background: var(--success);
    }

    .btn-success:hover {
      background: #27ae60;
    }

    .btn-block {
      display: block;
      width: 100%;
      margin-top: 15px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #bdc3c7;
    }

    input {
      width: 100%;
      padding: 14px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      color: white;
      font-size: 1.1rem;
    }

    input:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.3);
    }

    .info-text {
      color: #95a5a6;
      font-size: 0.9rem;
      margin-top: 5px;
    }

    .status-container {
      padding: 20px;
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.2);
      min-height: 80px;
      display: flex;
      align-items: center;
    }

    .status-message {
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .status-message.success {
      color: var(--success);
    }

    .status-message.error {
      color: var(--danger);
    }

    .status-message.warning {
      color: #f39c12;
    }

    .instructions {
      padding: 20px;
      background: rgba(44, 62, 80, 0.6);
      border-radius: 15px;
      margin-top: 30px;
    }

    .instructions h3 {
      margin-bottom: 15px;
      color: #3498db;
    }

    .instructions ol {
      padding-left: 20px;
      margin-bottom: 15px;
    }

    .instructions li {
      margin-bottom: 10px;
      line-height: 1.6;
    }

    .token-info {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }

.token-card {
  background: rgba(0, 0, 0, 0.2);
  padding: 15px;
  border-radius: 10px;
  text-align: center;
  flex: 1;
  min-width: 200px;
  min-height: 100px;
  word-break: break-all; /* ⭐ this wraps long addresses/symbols */
  display: flex;
  flex-direction: column;
  justify-content: center;
}

    .token-value {
      font-size: 1.3rem;
      font-weight: bold;
      color: #3498db;
      margin-top: 8px;
    }

    .footer {
      text-align: center;
      margin-top: 40px;
      padding: 20px;
      color: #95a5a6;
      font-size: 0.9rem;
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    @media (max-width: 600px) {
      .container {
        padding: 10px;
      }

      h1 {
        font-size: 2rem;
      }

      .card {
        padding: 20px;
      }

      .token-card {
        min-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Flash USDT Minting Portal</h1>
<p class="info-text">1 USDT = 1 USD equivalent</p>
    </header>

    <div class="card">
<h2 class="card-title">
  <img src="usdt-icon.png" alt="USDT Icon" width="24" height="24" />
  Wallet Connection
</h2>
      <div class="wallet-info">
        <div class="wallet-status">
          <div class="status-indicator" id="walletIndicator"></div>
          <span id="walletAddress">Wallet not connected</span>
        </div>
        <div class="network-info">
          <div class="network-status">
            <div class="status-indicator" id="networkIndicator"></div>
            <span id="networkName">Network: Not connected</span>
          </div>
          <span id="chainId"></span>
        </div>
        <button class="btn btn-block pulse" id="connect" onclick="connectWallet()">Connect TronLink Wallet</button>
      </div>
    </div>

<div class="card">
  <h2 class="card-title">
    <img src="usdt-icon.png" alt="USDT Icon" width="24" height="24" />
    Mint Flash USDT
  </h2>
  <div class="form-group">
    <label for="mint-amount">Amount to Mint</label>
    <input type="number" id="mint-amount" placeholder="Enter amount (e.g., 100)" min="1" step="any">
    <p class="info-text">1 fUSDT = 1 USDT equivalent</p>
  </div>
  <div class="form-group">
    <label for="expiry">Expiry Duration (in seconds)</label>
    <input type="number" id="expiry" placeholder="Enter expiry time (e.g., 3600)" min="60" value="3600">
    <p class="info-text">Example: 3600 seconds = 1 hour (min: 60 seconds)</p>
  </div>
  <button class="btn btn-success btn-block" id="mint" type="button" onclick="mint()">Mint Flash USDT</button>

  <!-- ✅ These 2 elements were missing -->
  <div class="form-group" style="margin-top: 15px;">
    <div id="balance" class="info-text"></div>
    <div id="usd-value" class="info-text"></div>
  </div>
</div>

    <div class="card">
      <h2 class="card-title">Transaction Status</h2>
      <div class="status-container">
        <p class="status-message" id="status">
          <span>ⓘ</span> Connect your wallet to get started
        </p>
      </div>
    </div>

    <div class="token-info">
      <div class="token-card">
        <div>Contract Address</div>
        <div class="token-value">TXr7XvZ2AhjbbTPZtJ1yMo9XVVKDukuoag</div>
      </div>
      <div class="token-card">
        <div>Token Name</div>
        <div class="token-value">Flash USDT</div>
      </div>
<div class="token-card">
  <div>Token Symbol</div>
  <div class="token-value">USDT</div>
</div>
      <div class="token-card">
        <div>Decimals</div>
        <div class="token-value">6</div>
      </div>
    </div>

    <div class="instructions">
      <h3>How to Use:</h3>
      <ol>
        <li>Install TronLink wallet extension for your browser</li>
<li>Connect your wallet (make sure you're on Tron Mainnet)</li>
<li>Make sure you have some TRX for transaction fees on Tron Mainnet</li>
        <li>Enter the amount of USDT you want to mint</li>
        <li>Set expiration time in seconds (3600 = 1 hour)</li>
        <li>Click "Mint Flash USDT" and confirm the transaction</li>
      </ol>
<p class="subtitle">Mint USDT tokens with expiration on Tron Mainnet</p>
    </div>
 
  </div>

  <script>
    // Global contract information
    const CONTRACT_ADDRESS = "TXr7XvZ2AhjbbTPZtJ1yMo9XVVKDukuoag";
    const TOKEN_DECIMALS = 6;
    const NILE_CHAIN_ID = "0xcd8690dc";
    
    // Contract ABI - only mint function
    const CONTRACT_ABI = [
      {
        "constant": false,
        "inputs": [
          {"name": "_to", "type": "address"},
          {"name": "_amount", "type": "uint256"},
          {"name": "_durationInSeconds", "type": "uint256"}
        ],
        "name": "mint",
        "outputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
      }
    ];

    // State variables
    let contractInstance = null;
    let isConnected = false;

    // Initialize on page load
    document.addEventListener("DOMContentLoaded", function() {
      // Initialize UI
      updateUI();
      
      // Auto-connect if possible
      if (window.tronLink && window.tronLink.ready) {
        connectWallet();
      }
    });

    // Update UI based on connection status
    function updateUI() {
      const walletIndicator = document.getElementById("walletIndicator");
      const networkIndicator = document.getElementById("networkIndicator");
      const walletAddress = document.getElementById("walletAddress");
      const networkName = document.getElementById("networkName");
      const chainId = document.getElementById("chainId");
      const mintButton = document.getElementById("mint");

      if (!window.tronWeb || !tronWeb.defaultAddress.base58) {
        walletIndicator.className = "status-indicator";
        networkIndicator.className = "status-indicator";
        walletAddress.textContent = "Wallet not connected";
        networkName.textContent = "Network: Not connected";
        chainId.textContent = "";
        mintButton.disabled = true;
        setStatus("ⓘ Connect your TronLink wallet to get started", "info");
        return;
      }

      const currentAddress = tronWeb.defaultAddress.base58;
      walletIndicator.className = "status-indicator connected";
      walletAddress.textContent = `Connected: ${currentAddress.substring(0, 6)}...${currentAddress.slice(-4)}`;
      
const nodeHost = (tronWeb?.fullNode?.host || "").toLowerCase();

if (nodeHost.includes("trongrid") || nodeHost.includes("mainnet") || nodeHost.includes("api.trongrid.io")) {
  networkIndicator.className = "status-indicator connected";
  networkName.textContent = "Network: Tron Mainnet";
  chainId.textContent = "Chain ID: 0x2b6653dc";
  mintButton.disabled = false;
  setStatus("✅ Wallet connected to Tron Mainnet. Ready to mint USDT", "success");
} else {
  networkIndicator.className = "status-indicator";
  networkName.textContent = "Network: Wrong Network";
  chainId.textContent = "Switch to Tron Mainnet";
  mintButton.disabled = true;
  setStatus("⚠️ Please switch to Tron Mainnet in TronLink", "warning");
}
    }

    // Set status message
    function setStatus(message, type = "info") {
      const statusElement = document.getElementById("status");
      statusElement.innerHTML = `<span>${getStatusIcon(type)}</span> ${message}`;
      statusElement.className = `status-message ${type}`;
    }

    // Get status icon
    function getStatusIcon(type) {
      switch (type) {
        case "success": return "✅";
        case "error": return "❌";
        case "warning": return "⚠️";
        default: return "ⓘ";
      }
    }

    // Connect wallet
    async function connectWallet() {
      try {
        if (!window.tronLink) {
          setStatus("❌ TronLink not detected. Please install TronLink extension.", "error");
          return;
        }

        await window.tronLink.request({ method: 'tron_requestAccounts' });
        
        // Initialize contract
        contractInstance = await window.tronWeb.contract(CONTRACT_ABI, CONTRACT_ADDRESS);
        isConnected = true;
        
        updateUI();
      } catch (e) {
        console.error("Connection error:", e);
        setStatus(`❌ Connection failed: ${e.message || e}`, "error");
      }
    }

    // Helper function to wait for transaction confirmation
    async function waitForTransactionConfirmation(txID) {
      return new Promise((resolve) => {
        const checkInterval = setInterval(async () => {
          try {
            const txInfo = await window.tronWeb.trx.getTransactionInfo(txID);
            if (txInfo && txInfo.id) {
              clearInterval(checkInterval);
              resolve(txInfo);
            }
          } catch (e) {
            // Ignore and try again
            console.log('Waiting for confirmation...');
          }
        }, 1000);
      });
    }

    // Mint tokens - FIXED VERSION
    async function mint() {
      try {
        // Validate connection
        if (!isConnected || !contractInstance) {
          setStatus("❌ Please connect wallet first", "error");
          return;
        }

        // Get input values
        const amountInput = document.getElementById("mint-amount").value;
        const expiryInput = document.getElementById("expiry").value;

        // Validate inputs
        if (!amountInput || parseFloat(amountInput) <= 0) {
          setStatus("❌ Please enter a valid amount (min 1 token)", "error");
          return;
        }
        
        if (!expiryInput || parseInt(expiryInput) < 60) {
          setStatus("❌ Please enter a valid expiry time (min 60 seconds)", "error");
          return;
        }

        // Convert values
        const tokenAmount = Math.floor(parseFloat(amountInput) * 10 ** TOKEN_DECIMALS);
        const expiryValue = parseInt(expiryInput);
        
        // Convert address to hex format (required by contract)
        const hexAddress = window.tronWeb.address.toHex(tronWeb.defaultAddress.base58);
        
        setStatus("⏳ Processing mint request...", "info");

        // Execute mint transaction - FIXED PART
        const tx = await contractInstance.mint(
          hexAddress,
          tokenAmount, 
          expiryValue
        ).send({
          feeLimit: 150000000,
          callValue: 0
        });

        // FIXED: Handle different possible result formats from TronWeb
        let txID = null;
        if (typeof tx === 'string') {
          txID = tx; // Sometimes TronWeb returns txID as string directly
        } else if (tx && tx.txID) {
          txID = tx.txID; // Standard format
        } else if (tx && tx.txid) {
          txID = tx.txid; // Alternative format
        } else if (tx && tx.transaction && tx.transaction.txID) {
          txID = tx.transaction.txID; // Nested format
        } else {
          console.log("Full tx result:", tx);
          throw new Error("Could not extract transaction ID from result");
        }

        setStatus("⏳ Transaction sent. Waiting for confirmation...", "info");
        
        // Wait for transaction confirmation
        const txInfo = await waitForTransactionConfirmation(txID);
        
        // Handle transaction response
        if (txInfo && txInfo.receipt && txInfo.receipt.result === 'SUCCESS') {
          setStatus(`✅ Mint successful! TX: ${txID}`, "success");
          
          // Clear inputs
          document.getElementById("mint-amount").value = "";
          document.getElementById("expiry").value = "3600";
        } else {
          const reason = txInfo.resMessage || "No result received";
          setStatus(`❌ Transaction failed: ${reason}`, "error");
        }
      } catch (e) {
        console.error("Mint error:", e);
        
        // Handle specific errors
        let errorMsg = "Mint failed";
        if (e.message.includes("revert")) {
          errorMsg = "Contract reverted transaction - check contract requirements";
        } else if (e.message.includes("denied")) {
          errorMsg = "Transaction denied by user";
        } else if (e.message.includes("insufficient")) {
          errorMsg = "Insufficient energy/bandwidth - get more test TRX";
        } else if (e.message.includes("onlyOwner")) {
          errorMsg = "Only contract owner can mint tokens";
        } else if (e.message.includes("Invalid address format")) {
          errorMsg = "Address format error - please reconnect wallet";
        } else {
          errorMsg = e.message || "Unknown error";
        }
        
        setStatus(`❌ ${errorMsg}`, "error");
      }
    }
  </script>
</body>
</html>
