<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Flash USDT Mint (Testnet)</title>
  <script src="https://cdn.jsdelivr.net/npm/tronweb@4.1.0/dist/TronWeb.js"></script>
</head>
<body style="background-color:#121212;color:#eee;padding:20px;font-family:sans-serif;">
  <h2>🚀 Flash USDT Minting Portal (Shasta Testnet)</h2>

  <div>
    <p id="walletAddress">🔌 Wallet: Not connected</p>
    <button id="connectBtn">Connect TronLink</button>
  </div>

  <hr style="margin: 20px 0;">

  <div>
    <h3>💰 Mint Flash USDT</h3>
    <input type="number" id="mintAmount" placeholder="Enter USDT amount" style="padding:5px;" />
    <button id="mintBtn">Mint Flash USDT</button>
  </div>

  <script>
    const CONTRACT_ADDRESS = "TQ1wNmuBGDzhJKxGsHWVDuMB7GmMpT4KcT"; // Flash USDT testnet contract

    let tronWeb;
    let currentAddress;
    let contract;

    async function connectWallet() {
      if (window.tronLink) {
        try {
          await window.tronLink.request({ method: 'tron_requestAccounts' });
          tronWeb = window.tronWeb;

          if (!tronWeb.defaultAddress.base58) {
            alert("TronWeb not ready. Please wait and try again.");
            return;
          }

          currentAddress = tronWeb.defaultAddress.base58;
          document.getElementById("walletAddress").textContent = "🔌 Wallet: " + currentAddress;

          contract = await tronWeb.contract().at(CONTRACT_ADDRESS);
          console.log("Wallet connected & contract loaded.");
        } catch (e) {
          alert("Failed to connect wallet.");
          console.error(e);
        }
      } else {
        alert("TronLink is not installed.");
      }
    }

    async function mintToken() {
      try {
        await window.tronLink.request({ method: 'tron_requestAccounts' });
        const amount = document.getElementById("mintAmount").value;

        if (!amount || isNaN(amount) || amount <= 0) {
          alert("❌ Please enter a valid mint amount.");
          return;
        }

        const expiry = Math.floor(Date.now() / 1000) + 3600; // 1 hour expiry

        const tx = await contract.mintWithExpiry(currentAddress, tronWeb.toSun(amount), expiry).send();
        console.log("TX:", tx);
        alert("✅ Minted " + amount + " USDT (Flash)");
      } catch (e) {
        alert("Transaction failed: " + e.message);
        console.error(e);
      }
    }

    document.getElementById("connectBtn").addEventListener("click", connectWallet);
    document.getElementById("mintBtn").addEventListener("click", mintToken);
  </script>
</body>
</html>
